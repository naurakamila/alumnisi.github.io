!function i(n,a,o){function r(t,e){if(!a[t]){if(!n[t]){var s="function"==typeof require&&require;if(!e&&s)return s(t,!0);if(l)return l(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}s=a[t]={exports:{}},n[t][0].call(s.exports,function(e){return r(n[t][1][e]||e)},s,s.exports,i,n,a,o)}return a[t].exports}for(var l="function"==typeof require&&require,e=0;e<o.length;e++)r(o[e]);return r}({1:[function(e,t,s){"use strict";e("./messages")},{"./messages":3}],2:[function(h,e,p){!function(t){!function(){"use strict";Object.defineProperty(p,"__esModule",{value:!0}),p.default=void 0;var e,r=(e="undefined"!=typeof window?window.jQuery:void 0!==t?t.jQuery:null)&&e.__esModule?e:{default:e},s="undefined"!=typeof window?window._:void 0!==t?t._:null,n="undefined"!=typeof window?window.peepso:void 0!==t?t.peepso:null,a="undefined"!=typeof window?window.peepsodata:void 0!==t?t.peepsodata:null,l=h("./util");const i=window.peepsomessagesdata&&peepsomessagesdata.character_limit,o=window.peepsomessagesdata&&peepsomessagesdata.send_button_text,d=window.peepsomessagesdata&&peepsomessagesdata.mute_confirm;p.default=class{constructor(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.$container=(0,r.default)(e.el),this.$wrapper=this.$container.closest(".ps-js-conversation-wrapper"),this.$back=this.$container.find(".ps-js-conversation-back"),this.$recipients=this.$container.find(".ps-js-recipients"),this.$addRecipients=this.$container.find(".ps-js-add-recipients"),this.$participants=this.$container.find(".ps-js-conversation-participant-summary"),this.$scrollable=this.$container.find(".ps-js-conversation-scrollable"),this.$messages=this.$container.find(".ps-js-conversation-messages"),this.$messagesLoading=this.$container.find(".ps-js-conversation-messages-loading"),this.$messagesList=this.$container.find(".ps-js-conversation-messages-list"),this.$messagesTemporary=this.$container.find(".ps-js-conversation-messages-temporary"),this.$messagesTyping=this.$container.find(".ps-js-conversation-messages-typing"),this.$messageTemplate=this.$container.find("[data-template=message-item]"),this.$loading=this.$container.siblings(".ps-js-conversation-loading"),this.$options=this.$container.find(".ps-js-conversation-options"),this.$optionsDropdown=this.$container.find(".ps-js-conversation-dropdown"),this.$postboxTemplate=this.$container.find("[data-template=postbox]"),this.$postbox=null,this.$enterToSend=null,this.opts=r.default.extend({},e),this.params={msg_id:this.opts.id},this.enterToSend=!1,this.$back.off("click").on("click",e=>{e.preventDefault(),this.hide()}),this.show(),this.load()}show(){this.$wrapper.addClass("ps-messages__view--open")}hide(){this.$wrapper.removeClass("ps-messages__view--open")}fetch(){let t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=r.default.ajax({url:a.ajaxurl_legacy+"messagesajax.get_messages_in_conversation",type:"POST",dataType:"json",data:t}),s=r.default.Deferred();return s.abort=e.abort,e.done(e=>{e.success?s.resolve(e.data):e.errors&&1===t.page?s.reject(e.errors):s.resolve({})}),e.fail(()=>s.reject()),s}load(){var e=r.default.extend(this.params,{get_participants:1,get_options:1,get_unread:1});this.$container.hide(),this.$loading.show(),this.fetch(e).done(e=>{this.render(e),void 0!==e.enter_to_send&&(this.enterToSend=+e.enter_to_send),this.initPostbox(),this.initOptions(),this.initRecipientsForm(),this.startLongPolling(),setTimeout(()=>this.maybeLoadPrevious(),2e3)}).always(()=>{this.$loading.hide(),this.$container.show()})}maybeLoadPrevious(){let e="scroll.ps-page-messages";this.$scrollable.off(e),this.$scrollable.on(e,()=>{this.$scrollable[0].scrollTop<30&&(this.$scrollable.off(e),this.loadPrevious().then(e=>{e.html&&this.maybeLoadPrevious()}))})}loadPrevious(){return new Promise((t,e)=>{this.$messagesLoading.css("visibility","");let s=this.$messagesList.children(".ps-js-message").first();var i={msg_id:this.params.msg_id,from_id:s.data("id"),direction:"old",get_unread:1};this.fetch(i).done(e=>{this.render(e,"prepend"),setTimeout(()=>t(e),1e3)}).fail(e).always(()=>{this.$messagesLoading.css("visibility","hidden")})})}loadNext(){let e=this.$messagesList.children(".ps-js-message").last();var t={msg_id:this.params.msg_id,from_id:e.data("id"),direction:"new",get_unread:1};return this.loadNextPromise&&this.loadNextPromise.abort(),this.loadNextPromise=this.fetch(t),this.loadNextPromise.done(e=>{let t=this.$messagesTemporary.children(".ps-js-temporary-message");(t=e.ids&&e.ids.length?t.slice(0,e.ids.length):t).remove(),this.render(e),(e.currently_typing||e.ids&&e.ids.length)&&this.restartLongPolling()}),this.loadNextPromise}render(e){var t,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"append";let i=this.$scrollable[0],n,a,o;this.destroyed||((e.ids&&e.ids.length||e.currently_typing)&&("append"===s?n=Math.abs(i.scrollHeight-i.clientHeight-i.scrollTop):"prepend"===s&&(t=getComputedStyle(i.firstElementChild).paddingTop,t=parseInt(t)||0,a=this.$messagesLoading.outerHeight()+t-i.scrollTop,o=this.$messagesList[0].firstElementChild)),e.html&&(t=(0,l.filterMessages)((0,r.default)(e.html)),"append"===s?this.$messagesList.append(t):"prepend"===s&&this.$messagesList.prepend(t)),e.html_participants&&this.$participants.html(e.html_participants),e.html_options&&this.$optionsDropdown.html(e.html_options),void 0!==e.receipt&&+e.receipt&&(t=+e.unread||0,this.showUnreadCheckmark(t)),!e.currently_typing||e.ids&&e.ids.length?this.$messagesTyping.empty():this.$messagesTyping.html(e.currently_typing),"append"===s&&n<30?(e.ids&&e.ids.length||e.currently_typing)&&requestAnimationFrame(()=>{i.scrollTop=i.scrollHeight,(0,l.loadAsyncContents)(e.html).then(()=>{i.scrollTop=i.scrollHeight})}):"prepend"===s&&(t=o?(0,r.default)(o).position().top:0,i.scrollTop=Math.max(0,t-a)))}initPostbox(){let e=this.$container.find("div#postbox-message").html(this.$postboxTemplate.html()),t=null;this.$postbox=e.pspostbox({text_length:i,send_button_text:o,save_url:"messagesajax.add_message",postbox_req:e=>(this.isSaving=!0,e.parent_id=this.params.msg_id,t=e),on_before_save:()=>{let e;switch(t.type){case"photo":e={type:"photo",count:t.files.length};break;case"giphy":e={type:"giphy",count:1}}this.$postbox.find(".ps-postbox-input:visible textarea").val(""),this.addTemporaryContent(t.content,e),this.$scrollable[0].scrollTop=this.$scrollable[0].scrollHeight},on_save:()=>this.loadNext(),on_queue_clear:()=>{this.isSaving=!1,this.$postbox.$posttabs.on_cancel()}}),this.$postbox.$posttabs.off("peepso_posttabs_submit"),this.$enterToSend=this.$postbox.find("#enter-to-send"),this.$enterToSend[0].checked=this.enterToSend,this.$enterToSend.on("click",()=>{this.$postbox.on_change(),n.ajax.post("messagesajax.enter_to_send",{enter_to_send:this.$enterToSend.is(":checked")?1:0})}),this.$postbox.$textarea.on("focus click",(0,s.throttle)(function(){n.ajax.post("messagesajax.mark_read_messages_in_conversation",{msg_id:this.params.msg_id})},2e3).bind(this)),this.$postbox.on("postbox.post_cancel postbox.post_saved",e=>{this.$postbox.$textarea.trigger("keyup").trigger("input")}),n.observer.addFilter("peepso_postbox_enter_to_send",()=>this.$enterToSend.is(":checked")),n.observer.addFilter("peepso_postbox_input_changed",(e,t)=>{t===this.$postbox&&(0,l.currentlyTyping)(this.params.msg_id)},10,2)}initOptions(){let t=(0,r.default)(document),s="click.conversation-options";this.$options.off(s).on(s,e=>{if(e.stopPropagation(),this.$optionsDropdown.is(":visible"))return this.$optionsDropdown.hide(),void t.off(s);this.$optionsDropdown.show(),t.one(s,()=>this.$optionsDropdown.hide())}),this.$optionsDropdown.off("click").on("click","[data-menu]",e=>{e.preventDefault();let t=(0,r.default)(e.currentTarget);switch(t.data("menu")){case"block-user":this.blockUser(t.data("warningText"),t.data("userId"));break;case"add-recipients":this.addRecipients();break;case"toggle-read-receipt":this.toggleReadReceipt(!+t.data("send"),t[0]);break;case"toggle-mute":this.toggleMute(!+t.data("muted"),t[0]);break;case"leave-conversation":this.leaveConversation(t.data("warningText"),t.attr("href"))}})}initRecipientsForm(){let i={};this.$recipients.find("select[name=recipients]").selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option:function(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`},item:function(e,t){var s=t(e.display_name);return`<div><img src="${t(e.avatar||i[e.id]||"")}" /><span>${s}</span></div>`}},load:(e,s)=>{n.ajax.post("messagesajax.get_available_recipients",{parent_id:this.params.msg_id,keyword:e}).done(e=>{let t;e.success&&(t=e.data.available_participants||[],r.default.each(t,function(e,t){i[t.id]=t.avatar})),s(t)})},onInitialize:function(){var e=`<img src="${this.$input.data("loading")}" />`;this.$wrapper.append(e),this.$control_input.on("input",function(e){let t=(0,r.default)(this);setTimeout(function(){t.trigger("keyup")},0)})}}),this.$addRecipients.off("click").on("click",()=>{let s=this.$recipients.find("select[name=recipients]"),e=this.$recipients.find("select[name=add-participant-nonce]");var t={parent_id:this.params.msg_id,participants:s.val(),add_participant_nonce:e.val()};n.ajax.post("messagesajax.add_participants",t).done(e=>{if(e.success){var t=e.data.new_conversation_redirect;if(t)return window.location=t,void window.location.reload();this.$participants.html(e.data.summary),(0,n.dialog)(e.notices[0]).show().autohide(),s.find("option").remove(),r.default.each(e.data.available_participants,function(e,t){t=(0,r.default)("<option/>").val(t.id).text(t.display_name);s.append(t)}),s[0].selectize.clearOptions(!0),this.$recipients.slideUp()}})})}showUnreadCheckmark(e){let t=this.$messagesList.find(".gci-check-circle"),s=(0,r.default)();0<e&&(s=t.slice(0-e),t=t.not(s)),t.addClass("read"),s.removeClass("read")}blockUser(e,t){(0,n.dialog)(e).confirm(e=>{e&&window.ps_member.block_user(t)})}addRecipients(){this.$recipients.slideDown()}addTemporaryContent(e,t){e=(0,n.template)(this.$messageTemplate.text())({content:e,attachment:t});this.$messagesTemporary.append(e)}toggleReadReceipt(t,s){var e={msg_id:this.params.msg_id,read_notif:t?1:0};n.ajax.post("messagesajax.set_message_read_notification",e).done(e=>{if(e.success){if(s instanceof Element){let e=(0,r.default)(s);e.data("send",t?1:0),e.removeClass("disabled").addClass(t?"":"disabled"),e.find("span").text(e.data(`${t?"dontSend":"send"}Text`))}t&&n.ajax.post("messagesajax.mark_read_messages_in_conversation",{msg_id:this.params.msg_id})}})}toggleMute(e,i){if(e){let t=(0,n.dialog)(d.replace("{msg_id}",this.params.msg_id)).show(),s=t.$el.find("input[type=radio]"),e=t.$el.find("input[type=button]");e.removeAttr("onclick"),e.on("click",e=>{e.preventDefault(),this.toggleMuteConfirm(s.filter(":checked").val(),i),t.hide()})}else this.toggleMuteConfirm(0,i)}toggleMuteConfirm(e,t){let s={parent_id:this.params.msg_id,mute:e},i=!!+e;n.ajax.post("messagesajax.set_mute",s).done(e=>{if(e.success){if(t instanceof Element){let e=(0,r.default)(t);e.data("muted",i?1:0),e.find("span").text(e.data(`${i?"muted":"unmuted"}Text`)),e.find("i").attr("class",i?"gcis gci-bell-slash":"gcir gci-bell")}n.observer.doAction(`psmessages_conversation_${i?"":"un"}mute`,s.parent_id)}})}leaveConversation(e,t){(0,n.dialog)(e).confirm(e=>{e&&(window.location=t)})}destroy(){var e;this.stopLongPolling(),this.$container.hide(),this.$addRecipients.off("click"),this.$recipients.hide(),(e=this.$recipients.find("select[name=recipients]")[0].selectize)&&e.destroy(),this.hide(),this.$messagesList.children().remove(),this.$container.find("div#postbox-message").empty(),this.$postbox=null,this.destroyed=!0}startLongPolling(){this.longPollingToken=(new Date).getTime();let s=this.longPollingToken,i=t=>{this.longPollingTimer=setTimeout(()=>{this.loadNext().always(()=>{var e;this.destroyed?console.log(`Requested conversation thread (${this.params.msg_id}) is no longer exist. `+"Terminate corresponding long polling loop!"):s!==this.longPollingToken?console.log("Different token. Terminate corresponding long polling loop!"):(e=Math.min(+a.notification_ajax_delay_multiplier*t,+a.notification_ajax_delay),i(e))})},t)};i(+a.notification_ajax_delay_min)}stopLongPolling(){clearTimeout(this.longPollingTimer),this.longPollingToken=null}restartLongPolling(){this.stopLongPolling(),this.startLongPolling()}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./util":5}],3:[function(o,e,t){!function(s){!function(){"use strict";var i=t("undefined"!=typeof window?window.jQuery:void 0!==s?s.jQuery:null),n="undefined"!=typeof window?window._:void 0!==s?s._:null,e="undefined"!=typeof window?window.peepso:void 0!==s?s.peepso:null,a=t(o("./list"));function t(e){return e&&e.__esModule?e:{default:e}}e.observer.addFilter("chat_enabled",function(e){return e=document.querySelector(".ps-js-messages-list")?!1:e}),(0,i.default)(function(){var s=document.querySelector(".ps-js-messages-list");if(s){new a.default({el:s});let e=(0,i.default)(".ps-js-messages"),t="ps-messages--narrow";s="resize.ps-message-conversation";(0,i.default)(window).off(s).on(s,(0,n.throttle)(function(){e.width()<800?e.addClass(t):e.removeClass(t)})).triggerHandler(s)}})}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./list":4}],4:[function(l,e,d){!function(r){!function(){"use strict";Object.defineProperty(d,"__esModule",{value:!0}),d.default=void 0;var n=e("undefined"!=typeof window?window.jQuery:void 0!==r?r.jQuery:null),t="undefined"!=typeof window?window.peepso:void 0!==r?r.peepso:null,a="undefined"!=typeof window?window.peepsodata:void 0!==r?r.peepsodata:null,s=l("./util"),i=e(l("./conversation"));function e(e){return e&&e.__esModule?e:{default:e}}const o=window.peepsomessagesdata&&peepsomessagesdata.per_page;d.default=class{constructor(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=(this.$container=(0,n.default)(e.el),this.$form=this.$container.find(".ps-js-messages-search-form"),this.$query=this.$form.find("input[name=query]"),this.$btnClear=this.$form.find(".ps-js-btn-clear").hide(),this.$btnShowAll=(0,n.default)(".ps-js-messages-show-all"),this.$btnShowUnread=(0,n.default)(".ps-js-messages-show-unread"),this.$scrollable=this.$container.find(".ps-js-messages-list-scrollable"),this.$table=this.$container.find(".ps-js-messages-list-table"),this.$loading=this.$container.find(".ps-js-messages-list-loading"),this.opts=e,this.foundPages=0,this.currentConversationID=null,this.conversation=null,this.params={type:"inbox",unread_only:0,query:null,page:1,per_page:o},this.$query.on("input",()=>{var e=this.$query.val().trim();e.length?this.$btnClear.show():this.$btnClear.hide(),(!e||3<=e.length)&&e!==this.params.query&&(this.params.query=e,this.load())}),this.$query.trigger("input"),this.$query.on("keyup",e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),(e=this.$query.val().trim()).length?this.$btnClear.show():this.$btnClear.hide(),e!==this.params.query&&(this.params.query=e,this.load()))}),this.$btnClear.on("click",()=>{this.$btnClear.hide(),this.$query.removeAttr("value").val(""),this.params.query&&(this.params.query="",this.load())}),this.$btnShowAll.on("click",e=>{e.preventDefault(),this.params.unread_only=0,this.$btnShowAll.addClass("active"),this.$btnShowUnread.removeClass("active"),this.load()}),this.$btnShowUnread.on("click",e=>{e.preventDefault(),this.params.unread_only=1,this.$btnShowAll.removeClass("active"),this.$btnShowUnread.addClass("active"),this.load()}),this.$table.on("click",".ps-js-messages-list-item",e=>{e=+(0,n.default)(e.currentTarget).data("conversation-id");e&&(this.getIDFromURL()===e?this.select(e):this.updateURL(e))}),window.addEventListener("hashchange",e=>{var t=e.oldURL.match(/^([^#]+)(?:#(\d+))*/),e=e.newURL.match(/^([^#]+)#(\d+)/);t&&e&&t[1]===e[1]&&t[2]!==e[2]&&this.select(e[2])}),"peepso_messages_after_send.messages-list");(0,n.default)(window).off(e).on(e,()=>{setTimeout(()=>{this.currentConversationID=null,this.params.query=null,this.$query.trigger("input")},1e3)})}fetch(){let i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new Promise((t,s)=>{var e={url:a.ajaxurl_legacy+"messagesajax.get_messages",type:"POST",data:i,dataType:"json"};this.fetchXhr&&this.fetchXhr.abort(),this.fetchXhr=n.default.ajax(e).done(e=>{e.success?t(e.data):e.errors&&1===i.page?s(e.errors):t([])}).fail(s).always(()=>{delete this.fetchXhr})})}load(){this.params.page=1,this.$table.empty(),this.$loading.show(),this.fetch(this.params).then(e=>{this.foundPages=e.total_pages,this.$loading.hide(),this.params.query?this.$btnClear.show():this.$btnClear.hide();var t=(0,n.default)(e.html),t=(0,s.filterMessages)(t);if(this.$table.empty().append(t),this.highlightItem(this.currentConversationID),0<e.total){let t=this.getIDFromURL();if(!t&&10<this.$container.parent().width()-this.$container.width()){let e=this.$table.find(".ps-js-messages-list-item").first();t=e.data("conversation-id")}t&&!this.conversation&&this.select(t)}1<this.foundPages&&this.maybeLoadNext()}).catch(()=>{})}loadNext(){this.params.page++,this.$loading.show(),this.fetch(this.params).then(e=>{this.$loading.hide(),this.$table.append((0,s.filterMessages)((0,n.default)(e.html))),this.highlightItem(this.currentConversationID),this.foundPages>this.params.page&&this.maybeLoadNext()}).catch(()=>{})}maybeLoadNext(){if(this.$table.off("scroll"),this.currentConversationID){var e=`[data-conversation-id="${this.currentConversationID}"]`;if(!this.$table.children(e).length)return void this.loadNext()}this.$table.on("scroll",()=>{var e=this.$table.innerHeight()+this.$table.scrollTop();this.$table[0].scrollHeight-e<30&&(this.$table.off("scroll"),this.loadNext())}),this.$table.trigger("scroll")}select(e){this.currentConversationID!==(e=+e)?(this.currentConversationID=e,this.updateURL(e),this.initConversation(e),this.highlightItem(e),this.markAsRead(e)):this.conversation&&this.conversation.show()}getIDFromURL(){let e=window.location.hash;if(e){var t=e.match(/^#(\d+)/);if(t)return+t[1]}return null}updateURL(e){e="#"+e;window.location.hash!==e&&(window.location.hash=e)}highlightItem(e){let t=this.$table.children(),s=t.filter(`[data-conversation-id="${e}"]`);e="ps-messages__list-item--selected";t.not(s).filter("."+e).removeClass(e),s.length&&!s.hasClass(e)&&(s.addClass(e),setTimeout(function(){s[0].scrollIntoView({block:"nearest",inline:"nearest"})},100))}initConversation(e){this.conversation instanceof i.default&&this.conversation.destroy(),this.conversation=new i.default({el:document.querySelector(".ps-js-conversation"),id:e})}markAsRead(e){t.ajax.post("messagesajax.mark_read_messages_in_conversation",{msg_id:e}),this.$table.children(`[data-conversation-id="${e}"]`).removeClass("ps-messages__list-item--unread")}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./conversation":2,"./util":5}],5:[function(e,t,o){!function(t){!function(){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.currentlyTyping=void 0,o.filterMessages=function(e){e=(0,s.default)(e).filter(function(){return Node.ELEMENT_NODE===this.nodeType});let t=(0,s.default)("<div/>").append(e);return t=i.observer.applyFilters("messages_render",t),i.observer.doAction("peepso_external_link",t),t.children()},o.loadAsyncContents=function(s){return new Promise(e=>{let t=[];if("string"==typeof s){let e=document.createElement("div");e.innerHTML=s,e.querySelectorAll(".ps-media__attachment img[src]").forEach(s=>{var e=new Promise(e=>{let t=new Image;t.onload=e,t.src=s.src});t.push(e)})}t.length?Promise.all(t).then(()=>{setTimeout(e,500)}):e()})},o.longPolling=void 0;var s=(e="undefined"!=typeof window?window.jQuery:void 0!==t?t.jQuery:null)&&e.__esModule?e:{default:e},e="undefined"!=typeof window?window._:void 0!==t?t._:null,i="undefined"!=typeof window?window.peepso:void 0!==t?t.peepso:null,n="undefined"!=typeof window?window.peepsodata:void 0!==t?t.peepsodata:null;let a={};e=(0,e.debounce)(function(e){var t={url:n.ajaxurl_legacy+"messagesajax.i_am_typing",type:"POST",data:{msg_id:e},dataType:"json"};a[e]&&a[e].abort(),a[e]=s.default.ajax(t).always(()=>{delete a[e]})},500);o.currentlyTyping=e;o.longPolling={immediate(){},start(){},stop(){}}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]);