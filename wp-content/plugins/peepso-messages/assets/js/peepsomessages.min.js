!function n(a,o,i){function r(t,e){if(!o[t]){if(!a[t]){var s="function"==typeof require&&require;if(!e&&s)return s(t,!0);if(d)return d(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}s=o[t]={exports:{}},a[t][0].call(s.exports,function(e){return r(a[t][1][e]||e)},s,s.exports,n,a,o,i)}return o[t].exports}for(var d="function"==typeof require&&require,e=0;e<i.length;e++)r(i[e]);return r}({1:[function(e,t,s){!function(n){!function(){"use strict";var e,u,d,f=(e="undefined"!=typeof window?window.jQuery:void 0!==n?n.jQuery:null)&&e.__esModule?e:{default:e},s="undefined"!=typeof window?window._:void 0!==n?n._:null,g=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=i(t);if(t&&t.has(e))return t.get(e);var s,n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(s in e){var o;"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&((o=a?Object.getOwnPropertyDescriptor(e,s):null)&&(o.get||o.set)?Object.defineProperty(n,s,o):n[s]=e[s])}n.default=e,t&&t.set(e,n);return n}("undefined"!=typeof window?window.peepso:void 0!==n?n.peepso:null),a="undefined"!=typeof window?window.peepsodata:void 0!==n?n.peepsodata:null;function i(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,s=new WeakMap;return(i=function(e){return e?s:t})(e)}{let t=function(){let e=new Audio(a.messages.sound_beep);e.volume=.7,(t=(0,s.debounce)(function(){console.log("peepso.beep");try{e.play()}catch(e){}},1e3))()};g.hooks.addAction("chat_unread_new","message",function(){document.hasFocus()||t()})}function t(){this.$recipient_select=null,this.query="",this.page={inbox:1,sent:1},this.ajax_req=!1,this.enter_to_send=!1,this.unread=void 0}function l(e,t){var s=t(e.display_name);return'<div><img src="'+t(e.avatar||d[e.id]||"")+'" /><span>'+s+"</span></div>"}function c(e,t){var s=t(e.display_name);return'<div><img src="'+t(e.avatar||d[e.id]||"")+'" /><span>'+s+"</span></div>"}window.ps_messages=g.default.messages=(u=new t,d={},t.prototype.init_conversation_view=function(t){(0,f.default)("#add-recipients-toggle").on("click",function(e){e.preventDefault(),(0,f.default)(".ps-js-recipients").slideToggle()}),(0,f.default)("#recipients-search").selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option:c,item:l},load:function(e,s){g.default.postJson("messagesajax.get_available_recipients",{parent_id:t,keyword:e},function(e){var t;e.success&&(t=e.data.available_participants||[],f.default.each(t,function(e,t){d[t.id]=t.avatar})),s(t)})},onInitialize:function(){var e='<img src="'+this.$input.data("loading")+'" />';this.$wrapper.append(e),this.$control_input.on("input",function(e){var t=(0,f.default)(this);setTimeout(function(){t.trigger("keyup")},0)})}}),this.$postbox=(0,f.default)("div#postbox-message").pspostbox({text_length:peepsomessagesdata.character_limit,send_button_text:peepsomessagesdata.send_button_text,save_url:"messagesajax.add_message",postbox_req:function(e){return u.saving=!0,e.parent_id=t,e},on_before_save:function(){(0,f.default)(".ps-postbox-input:visible textarea").val("")},on_save:function(e){u.polling||(u.polling=!0,u.load_next_in_conversation(t,"new"))},on_queue_clear:function(){u.saving=!1,u.$postbox.$posttabs.on_cancel()}}),this.$postbox.$textarea.on("focus click",_.throttle(function(){g.default.disableAuth().disableError().postJson("messagesajax.mark_read_messages_in_conversation",{msg_id:t})},2e3)),g.observer.addFilter("peepso_postbox_enter_to_send",function(){return u.enter_to_send}),g.observer.addFilter("peepso_postbox_input_changed",function(e){u.currently_typing()}),u.$conversation=(0,f.default)(".ps-chat__messages"),u.$loading=(0,f.default)(".ps-js-loading",u.$conversation),u.$typing=(0,f.default)(".ps-js-currently-typing",u.$conversation),u.$entersend=(0,f.default)(".ps-js-checkbox-entertosend"),u.$doc=(0,f.default)(document),u.$conversation.data({conversation_id:t}),u.$conversation.length&&(u.$conversation.css({maxHeight:"60vh",overflow:"auto"}).off("scroll").on("scroll",u.on_conversation_scroll).bind("mousewheel",function(e,t){var s=(0,f.default)(e.currentTarget);(0<t&&0===s.scrollTop()||t<0&&s.scrollTop()==s.get(0).scrollHeight-s.innerHeight())&&e.preventDefault()}),u.polling=!0,u.load_next_in_conversation(t),u.init_long_polling(1500)),u.enter_to_send=u.$entersend[0].checked,u.$entersend.on("click",u.toggle_entertosend),g.observer.addFilter("psmessages_conversation_view",function(){return!0}),g.observer.addAction("psmessages_conversation_mute",s=>{if(+s==+t){let e=(0,f.default)(".ps-js-btn-mute-conversation"),t=(e.attr("onclick","return ps_messages.unmute_conversation("+s+", 0);"),e.find("span").text(peepsomessagesdata.unmute_conversation),e.find("i"));t.attr("class","gcis gci-bell-slash")}},10,1),g.observer.addAction("psmessages_conversation_unmute",s=>{if(+s==+t){let e=(0,f.default)(".ps-js-btn-mute-conversation"),t=(e.attr("onclick","return ps_messages.mute_conversation("+s+", 1);"),e.find("span").text(peepsomessagesdata.mute_conversation),e.find("i"));t.attr("class","gcir gci-bell")}},10,1);(0,f.default)(".ps-js-btn-blockuser").on("click",function(e){confirm(peepsomessagesdata.blockuser_confirm_text)&&(e=(0,f.default)(e.currentTarget).data("user-id"),ps_member.block_user(e))});var e=(0,f.default)(".ps-js-conversation-options"),s=(0,f.default)(".ps-js-conversation-dropdown");e.on("click",function(e){s.toggle(),e.stopPropagation()}),s.on("click",function(e){e.stopPropagation()}),(0,f.default)(document).on("click",function(){s.hide()})},t.prototype.load_next_in_conversation=function(c,p){return f.default.Deferred(f.default.proxy(function(l){var e,t={msg_id:c},s=Math.floor((new Date).getTime()/1e3);"new"===p?(e=u.$conversation.find(".ps-js-message").last(),t.from_id=e.data("id"),t.direction=p,t.get_unread=1):"old"===p?(e=u.$conversation.find(".ps-js-message").first(),u.$loading.show(),t.from_id=e.data("id"),t.direction=p):u.$loading.show(),(!this.lastOnlineCheck||this.lastOnlineCheck<s-60)&&(this.lastOnlineCheck=s,t.get_participants=1),g.default.disableAuth().disableError().postJson("messagesajax.get_messages_in_conversation",t,function(t){var e,s,n,a,o;function i(e){return e.children(".ps-js-message").each(function(){var e=(0,f.default)(this),t=".ps-js-message-"+e.data("id");u.$conversation.find(t).length&&e.remove()}),e}if("old"===p?setTimeout(function(){var e;u.$loading.hide(),t.success&&t.data.ids&&t.data.ids.length&&(u.$conversation.stop(),e=u.$loading.next(),n=(0,f.default)("<div />").append(t.data.html),n=g.observer.applyFilters("messages_render",n),g.observer.doAction("peepso_external_link",n),i(n).insertAfter(u.$loading),u.$conversation.stop().scrollTop(Math.max(0,e.position().top-131)),u.$doc.trigger("peepso_messages_list_displayed"),u.$conversation.off("scroll").on("scroll",u.on_conversation_scroll))},1e3):("new"!==p&&u.$loading.hide(),u.polling=!1,t.success&&(u.submit_entertosend||u.toggle_entertosend(+t.data.enter_to_send),t.data.ids&&t.data.ids.length&&(n=(0,f.default)("<div />").append(t.data.html),n=g.observer.applyFilters("messages_render",n),g.observer.doAction("peepso_external_link",n),i(n).insertBefore(u.$typing),u.$doc.trigger("peepso_messages_list_displayed"),e=s=!0))),t.success&&t.data&&(!t.data.currently_typing||s?u.$typing.empty():(u.$typing.html(t.data.currently_typing),e=!0)),t.data&&t.data.users){for(var r=!1,d=0;d<t.data.users.length;d++)if(+t.data.users[d].online){r=!0;break}(0,f.default)(".ps-conversation__status").children().get(0).className=r?"gcis gci-circle":"gcir gci-clock"}t.data&&void 0!==t.data.receipt&&(o=+t.data.receipt,a=+t.data.unread,u.receipt===o&&u.unread===a||(u.receipt=o,u.unread=a,o&&u.toggle_message_checkmark(a))),t.data&&void 0!==t.data.send_receipt&&(o=+t.data.send_receipt,u.send_receipt!==o&&(u.send_receipt=o,u.update_checkmark(c,o))),e&&u.conversation_scroll2bottom(),l.resolve(!!s)})},this))},t.prototype.on_conversation_scroll=_.debounce(function(){u.$conversation[0].scrollTop<=10&&(u.$conversation.off("scroll"),u.load_next_in_conversation(u.$conversation.data("conversation_id"),"old"))},200),t.prototype.conversation_scroll2bottom=function(){u.$conversation.stop().scrollTop(u.$conversation[0].scrollHeight)},t.prototype.init_long_polling=function(e){this.smart_long_polling()},t.prototype.smart_long_polling=function(e){var s=this.$conversation.data("conversation_id"),t=+peepsodata.notification_ajax_delay_min,n=+peepsodata.notification_ajax_delay,a=+peepsodata.notification_ajax_delay_multiplier,o=Math.max(e||0,t),i=f.default.proxy(function(t){clearTimeout(this.pollingTimer),this.pollingTimer=setTimeout(f.default.proxy(function(){this.load_next_in_conversation(s,"new").done(function(e){t=e?o:Math.min(t*a,n),i(t)})},this),t)},this);i(o),g.observer.addAction("browser.inactive",function(){i(n)}),g.observer.addAction("browser.active",function(){i(t)})},t.prototype.currently_typing=_.throttle(function(){g.default.disableAuth().disableError().postJson("messagesajax.i_am_typing",{msg_id:u.$conversation.data("conversation_id")})},+peepsodata.notification_ajax_delay_min||5e3),t.prototype.toggle_entertosend=function(e){var t=u.$entersend[0],s=+e,n=!1;e&&e.target&&(s=+e.target.checked,u.submit_entertosend=n=!0,g.default.disableAuth().disableError().postJson("messagesajax.enter_to_send",{enter_to_send:s},function(){u.submit_entertosend=!1})),!n&&s===+t.checked||(t.checked=u.enter_to_send=!!s,u.$postbox.on_change())},t.prototype.new_message=function(a,s,e){var t;if(window.ps_chat&&"large"===g.default.screenSize()&&e)return t=(e=(0,f.default)(e)).find("img").css("display","inline"),void g.default.postJson("chatajax.get_chat_with",{recipient:a},function(e){e.success&&ps_chat.open_chat(e.data.msg_id),setTimeout(function(){t.hide()},1e3)});var n,o=this,e=(0,f.default)("<div />").append(peepsomessagesdata.template),i=pswindow.show(e.find(".dialog-title").html(),e.find(".dialog-content").html()).$container.find(".ps-dialog"),r=(g.observer.addAction("pswindow_before_close",n=function(e){g.observer.removeAction("pswindow_before_close",n),g.observer.doAction("psmessage_new_message_close",e)},10,1),i.addClass("ps-dialog-wide"),g.observer.addFilter("pswindow_close",function(){i.removeClass("ps-dialog-wide")},10,1),this.$message_postbox=(0,f.default)("#cWindowContent div.ps-postbox-message").pspostbox({autosize:!0,text_length:peepsomessagesdata.character_limit,save_url:"messagesajax.new_message",send_button_text:peepsomessagesdata.send_button_text,postbox_req:function(e){return{subject:"",message:e.content,recipients:o.$recipient_select.val()}},on_save:function(e){pswindow.hide().show("",e.notices[0]).fade_out(pswindow.fade_time),g.observer.removeFilter("beforeunload",r.beforeUnloadHandler),(0,f.default)(window).trigger("peepso_messages_after_send",[e])},on_error:function(e){alert(e.errors[0])}}));this.$recipient_single=(0,f.default)("#ps-window .ps-js-recipient-single").hide(),this.$recipient_multiple=(0,f.default)("#ps-window .ps-js-recipient-multiple").hide(),this.$recipient_select=(0,f.default)("select[name=recipients]",this.$recipient_multiple),r.$textarea.triggerHandler("input"),this.get_available_recipients(a,f.default.proxy(function(e){var n,t;!e instanceof Array&&(e=[]),s&&(t=e.filter(function(e){return e[s]})).length&&(e=t),f.default.each(e,function(e,t){d[t.id]=t.avatar;var s=(0,f.default)("<option/>").val(t.id).text(t.display_name);o.$recipient_select.append(s),a===parseInt(t.id)&&(s.attr("selected","selected"),n=t)}),void 0!==a?((0,f.default)("option[value!="+a+"]",this.$recipient_select).remove(),n&&(this.$recipient_single.find("img").attr("src",n.avatar).attr("alt",n.display_name),this.$recipient_single.find(".ps-comment-user").html(n.display_name),this.$recipient_single.find("a").attr("href",n.url),this.$recipient_single.show())):(this.$recipient_multiple.show(),this.$recipient_select.selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option:c,item:l},load:function(e,s){g.default.postJson("messagesajax.get_available_recipients",{keyword:e},function(e){var t;e.success&&(t=e.data.available_participants||[],f.default.each(t,function(e,t){d[t.id]=t.avatar})),s(t)})},onInitialize:function(){var e='<img src="'+this.$input.data("loading")+'" />';this.$wrapper.append(e),this.$control_input.on("input",function(e){var t=(0,f.default)(this);setTimeout(function(){t.trigger("keyup")},0)})},onChange:function(e){o.toggle_send_button(),this.$control_input.blur()}})),this.toggle_send_button()},this))},t.prototype.compact_map=function(e){0<e.closest(".ps-dialog").length&&e.find(".ps-postbox__location").addClass("ps-postbox__location--loaded")},t.prototype.get_available_recipients=function(t,s){var n;t&&this.available_recipients&&this.available_recipients[t]?s(this.available_recipients[t]):(n=(0,f.default)("#ps-window .ps-js-recipient-loading").show(),g.default.postJson("messagesajax.get_available_recipients",{user_id:t},f.default.proxy(function(e){n.hide(),e.success?(this.available_recipients=this.available_recipients||{},this.available_recipients[t]=e.data.available_participants,s(this.available_recipients[t])):s([])},this)))},t.prototype.toggle_send_button=function(){var e=this.$recipient_select.val();(e=e&&!e.length?null:e)?this.$message_postbox.$save_button._detached&&(this.$message_postbox.$save_button.appendTo(this.$message_postbox.$save_button._detached),this.$message_postbox.$save_button._detached=!1):(this.$message_postbox.$save_button._detached=this.$message_postbox.$save_button.parent(),this.$message_postbox.$save_button.detach())},t.prototype.add_recipients=function(e){var e={parent_id:e,participants:(0,f.default)("#recipients-search").val(),add_participant_nonce:(0,f.default)("input[name='add-participant-nonce']").val()},t=(0,f.default)(".ps-js-recipients .ps-btn-success"),s=t.find("img");t.attr("disabled","disabled"),s.show(),g.default.postJson("messagesajax.add_participants",e,function(e){e.success?e.data.new_conversation_redirect?window.location=e.data.new_conversation_redirect:(s.hide(),t.removeAttr("disabled"),(0,f.default)(".ps-js-participant-summary").html(e.data.summary),pswindow.show("",e.notices[0]),(0,f.default)("#recipients-search option").remove(),f.default.each(e.data.available_participants,function(e,t){option=(0,f.default)("<option/>").val(t.id).text(t.display_name),(0,f.default)("#recipients-search").append(option)}),(0,f.default)("#recipients-search").trigger("chosen:updated"),(0,f.default)(".ps-js-recipients").slideToggle()):(s.hide(),t.removeAttr("disabled"))})},t.prototype.toggle_checkboxes=function(e){e=(0,f.default)(e);e.parents(".ps-messages").find("input[type='checkbox']").prop("checked",e.prop("checked"))},t.prototype.load_messages=function(s,n,a){var o=this,e={type:s,page:n,per_page:peepsomessagesdata.per_page,query:a},i=(0,f.default)("#"+s);(0,f.default)(".ps-js-loading",i).show(),g.default.postJson("messagesajax.get_messages",e,function(t){var e;(0,f.default)(".ps-js-loading",i).hide(),t.success&&(e=(0,f.default)(t.data.html),a?(e.find("input[name=query]").val(a),e.find("button[type=reset]").show()):(e.find("input[name=query]").val(""),e.find("button[type=reset]").hide()),(e=g.observer.applyFilters("messages_render",e)).hide(),i.html(e),e.fadeIn("slow").one("click",".ps-js-prev",function(e){e.preventDefault(),--n<=0?n++:o.load_messages(s,n,a)}).one("click",".ps-js-next",function(e){e.preventDefault(),++n>t.data.total_pages?n--:o.load_messages(s,n,a)}).on("click",".ps-js-bulk-actions",function(e){o.apply_bulk_action(e.target,s,n)}),(0,f.default)(e,".ps-js-messages-search-form").on("reset submit",function(e){var t=(0,f.default)(this).find("input[name=query]");"reset"===e.type&&t.val(""),o.load_messages(s,1,t.val())}),(0,f.default)(document).trigger("peepso_messages_list_displayed"))})},t.prototype.apply_bulk_action=function(e,t,s){var e=(0,f.default)(e).closest("form"),n=e.serialize();(0,f.default)(".ps-js-messages-list .ps-js-messages-list-item input:checked").length?(e=e.find("select[name=action]").val())?this.ajax_req||"delete"===e&&!confirm(a.messages.text_bulk_delete_confirm)||this._bulk_action(n,t,s):alert(a.messages.text_bulk_action):alert(a.messages.text_bulk_no_items)},t.prototype._bulk_action=function(e,t,s){var n=this;return g.default.postJson("messagesajax.bulk_action",e,function(){n.ajax_req=!1,u.load_messages(t,s)}),!0},t.prototype.show_long_participants=function(){(0,f.default)("#summary-participants").hide(),(0,f.default)("#long-participants").fadeIn()},t.prototype.delete_single_message=function(t){return pswindow.confirm_delete(function(){pswindow.hide(),g.default.postJson("messagesajax.delete_from_conversation",{msg_id:t},function(e){e.success&&(0,f.default)(".ps-js-message-"+t).remove()})}),!1},t.prototype.open_image=function(e){g.default.lightbox([{content:'<div style="display:inline-block;"><img src="'+e+'" /></div>'}],{simple:!0})},t.prototype.toggle_checkmark=function(t,s){return u.update_checkmark(t,s),g.default.disableAuth().disableError().postJson("messagesajax.set_message_read_notification",{msg_id:t,read_notif:+s},function(e){e.success&&s&&g.default.disableAuth().disableError().postJson("messagesajax.mark_read_messages_in_conversation",{msg_id:t})}),!1},t.prototype.update_checkmark=function(e,t){(0,f.default)(".ps-chat__messages");var s=(0,f.default)(".ps-js-btn-toggle-checkmark");s.find("i");t?(s.attr("onclick","return ps_messages.toggle_checkmark("+e+", 0);"),s.find("span").text(peepsomessagesdata.hide_checkmark),s.removeClass("disabled")):(s.attr("onclick","return ps_messages.toggle_checkmark("+e+", 1);"),s.find("span").text(peepsomessagesdata.show_checkmark),s.addClass("disabled"))},t.prototype.toggle_message_checkmark=_.throttle(function(e){var t=u.$conversation.find(".gci-check-circle");t.addClass("read"),0<e&&t.slice(0-e).removeClass("read")},1e3),t.prototype.mute_conversation=function(e){e=peepsomessagesdata.mute_confirm.replace("{msg_id}",e);return pswindow.show(peepsomessagesdata.mute_conversation,e),!1},t.prototype.confirm_mute_conversation=function(t,e){pswindow.hide();let s=(0,f.default)(e),n=s.closest("form");e=n.find("input[type=radio]:checked").val();return g.default.postJson("messagesajax.set_mute",{parent_id:t,mute:e},e=>{e.success&&g.observer.doAction("psmessages_conversation_mute",t)}),!1},t.prototype.unmute_conversation=function(t){return g.default.postJson("messagesajax.set_mute",{parent_id:t,mute:0},e=>{e.success&&g.observer.doAction("psmessages_conversation_unmute",t)}),!1},t.prototype.leave_conversation=function(e,t){return pswindow.confirm(e,function(){window.location=(0,f.default)(t).attr("href")}),!1},(0,f.default)(function(){(0,f.default)("#messages-tab a[data-toggle='tab']").on("click",function(e){t=(0,f.default)((0,f.default)(this).attr("href")).attr("id"),u.load_messages(t,1)}),(0,f.default)(window).on("peepso_messages_after_send",function(e,t){window.location=t.data.url});var t,s=(0,f.default)(".ps-js-messages-notification");s.psnotification&&s.psnotification({view_all_link:peepsomessagesdata.messages_page,source:"messagesajax.get_latest",header:peepsomessagesdata.notification_header,before_click:function(){var e;return!(!window.ps_chat||"large"!==g.default.screenSize())||!!((e=s.find(".ps-js-counter")).length&&0<+e.eq(0).text())}}).on("notifications.shown",function(e,t){var s=".ps-notification__wrapper > .ps-js-notification-message";g.observer.applyFilters("messages_render",t.popover_list.find(s)),window.ps_chat&&"large"===g.default.screenSize()?t.popover_list.find(s).on("click",function(){ps_chat.open_chat((0,f.default)(this).data("id")),t.popover.hide()}):(0,f.default)(document.body).hasClass("wp-admin")?t.popover_list.find(s).on("click",function(){var e=(0,f.default)(this).data("url");window.open(e)}):t.popover_list.find(s).one("click",function(){var e=(0,f.default)(this).data("url");window.location=e})})}),u)}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]);