!function(t,e){function i(t){this.create(t)}var o,a;e.PhotoDropzone=(o=t,(a=e).npm.objectAssign(i.prototype,a.npm.EventEmitter.prototype,{template:psdata_photos_dropzone.template,templatePreview:psdata_photos_dropzone.template_preview,create:function(t){this.uploading=0,this.$el=o(this.template).appendTo(t),this.$photos=this.$el.find(".ps-js-photos"),this.$file=this.$el.find("input[type=file]"),this.$upload=this.$el.find(".ps-js-upload"),this.$upload.on("click",o.proxy(this.onUpload,this)),a.isWebdriver()&&(this.uploadInit(),this.uploadInitialized=!0)},empty:function(t){"save"!==t&&this.removeTempFiles(this.getPhotos()),this.$photos.find(".ps-js-preview").remove(),this.emit("photo_empty")},getPhotos:function(){var e=[];return this.$photos.find(".ps-js-preview").each(function(){var t=o(this).data("id");e.push(t)}),e},upload:function(){this.uploadInitialized||(this.uploadInit(),this.uploadInitialized=!0),this.$file.trigger("click")},uploadInit:function(){var i=peepsodata.currentuserid;this.$file.psFileupload({singleFileUploads:!0,sequentialUploads:!1,replaceFileInput:!0,dropZone:this.$el,pasteZone:null,dataType:"json",url:peepsodata.ajaxurl_legacy+"photosajax.upload_photo",add:o.proxy(this.uploadAdd,this),submit:o.proxy(function(t,e){e.formData=a.observer.applyFilters("photos_upload_req",{user_id:i},this)},this),progress:o.proxy(this.uploadProgress,this),done:o.proxy(this.uploadDone,this)}),this.on("photo_added",this.uploadAdded),this.on("photo_removed",this.uploadRemoved)},uploadAdd:function(t,e){this.$file=this.$el.find("input[type=file]"),this.validate(e)},uploadAdded:function(t,e){var i=o(this.templatePreview);i.find(".ps-js-progress").css({width:1}),i.on("click",".ps-js-rotate-l",{id:e,dir:"ccw"},this.onRotate.bind(this)),i.on("click",".ps-js-rotate-r",{id:e,dir:"cw"},this.onRotate.bind(this)),i.on("click",".ps-js-remove",{id:e},o.proxy(this.onRemove,this)),i.addClass("ps-js-preview-"+e),t.files[0].name.match(/\.gif$/i)&&i.find(".ps-js-rotate-l, .ps-js-rotate-r").remove(),this.$upload.before(i),t.preview=i,this.resetSortable()},uploadRemoved:function(t){var e=this.$photos.find(".ps-js-preview-"+t);e.fadeOut(500,o.proxy(function(){e.remove(),this.$photos.find(".ps-js-preview").length?this.resetSortable():this.emit("photo_empty")},this))},uploadProgress:function(t,e){var i=e.preview,e=100*e.loaded/e.total;e=Math.max(0,Math.min(98,e)),e+="%",i.find(".ps-js-progress").stop().animate({width:e},2e3),this.beforeUnloadHandler||(this.beforeUnloadHandler=function(){return!0},a.observer.addFilter("beforeunload",this.beforeUnloadHandler))},uploadDone:function(t,e){var i=e.preview,e=e.result;this.beforeUnloadHandler&&(a.observer.removeFilter("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null),e.success?(i.data("id",e.data.files[0]),i.find(".ps-js-img").html('<img src="'+e.data.thumbs[0]+'" />'),i.find(".ps-js-rotate-l, .ps-js-rotate-r").show(),i.find(".ps-js-remove").show(),i.find(".ps-js-progress").stop().animate({width:"100%"},1e3,function(){setTimeout(function(){i.find(".ps-js-progressbar").fadeOut()},1e3)})):e.errors&&e.errors.length&&(e=e.errors.join("<br/>"),(e=o("<div/>").append(e).attr("title",e)).css({color:"red",fontSize:".8em",height:"100%",overflow:"hidden",padding:4}),i.find(".ps-js-progress").stop().hide(),i.find(".ps-js-rotate-l, .ps-js-rotate-r").hide(),i.find(".ps-js-remove").show(),i.find(".ps-js-img").html(e)),this.emit("photo_upload_done",--this.uploading)},validate:function(t){var e=(new Date).getTime()+Math.floor(1e3*Math.random());this.emit("photo_added",t,e),this.emit("photo_upload_start",++this.uploading),this.validateQueue||(this.validateQueue=[]),this.validateQueue.push([t,e]),this._validate()},_validate:_.throttle(function(){var e,i,t,s;this._validateProgress||(s=this.validateQueue.shift())&&(this._validateProgress=!0,e=s[0],i=s[1],s=e.files[0],/\.(gif|jpg|jpeg|png|tif|tiff|webp)$/i.test(s.name)?(t=_.filter(this.getPhotos(),function(t){return t}),s=a.observer.applyFilters("photos_validate_req",{size:parseInt(s.size),filesize:parseInt(s.size),photos:t.length+1},this),o.ajax({type:"POST",url:peepsodata.ajaxurl_legacy+"photosajax.validate_photo_upload",data:s,dataType:"json"}).done(o.proxy(function(t){t.success?e.submit().done(o.proxy(function(){setTimeout(o.proxy(function(){this._validateProgress=!1,this._validate()},this),1e3)},this)).fail(o.proxy(function(t){this.emit("photo_upload_done",--this.uploading),this.validateFail(i),this._validateProgress=!1,this._validate()},this)):t.errors&&t.errors.length&&(this.emit("photo_upload_done",--this.uploading),this.validateError(i,t.errors.join("<br/>")),this._validateProgress=!1,this._validate())},this)).fail(o.proxy(function(t){this.emit("photo_upload_done",--this.uploading),this.validateFail(i),this._validateProgress=!1,this._validate()},this))):(this.emit("photo_upload_done",--this.uploading),this.validateError(i,peepsophotosdata.error_unsupported_format),this._validateProgress=!1,this._validate()))},1e3),validateError:function(t,e){t=this.$photos.find(".ps-js-preview-"+t),e=o("<div/>").append("<span>"+e+"</span>").attr("title",e);e.css({color:"red",display:"table",fontSize:".8em",height:"100%",overflow:"hidden",padding:4}).find("span").css({display:"table-cell",verticalAlign:"middle"}),t.find(".ps-js-progress").stop().hide(),t.find(".ps-js-rotate-l, .ps-js-rotate-r").hide(),t.find(".ps-js-remove").show(),t.find(".ps-js-img").html(e)},validateFail:function(t){var e=psdata_photos_dropzone.text_upload_failed_notice,t=this.$photos.find(".ps-js-preview-"+t),e=o("<div/>").append("<span>"+e+"</span>").attr("title",e);e.css({color:"red",display:"table",fontSize:".8em",height:"100%",overflow:"hidden",padding:4}).find("span").css({display:"table-cell",verticalAlign:"middle"}),t.find(".ps-js-progress").stop().hide(),t.find(".ps-js-rotate-l, .ps-js-rotate-r").hide(),t.find(".ps-js-remove").show(),t.find(".ps-js-img").html(e)},resetSortable:function(){this.$photos.sortable({items:".ps-js-preview"})},destroy:function(){this.removeTempFiles(this.getPhotos()),this.$el.remove()},removeTempFiles:function(t){_.isArray(t)&&1<=t.length&&(t={user_id:peepsodata.currentuserid,photo:t,_wpnonce:this.$el.find("[name=_wpnonce_remove_temp_files]").val(),_wp_http_referer:this.$el.find("[name=_wp_http_referer]").val()},t=a.observer.applyFilters("photos_remove_temp_files",t),a.postJson("photosajax.remove_temp_files",t))},onUpload:function(){this.upload()},onRotate:function(t){var e=t.data.id,t=t.data.dir,i=this.$photos.find(".ps-js-preview-"+e),e=i.data("id"),s=o("<div />").css({background:"rgba(255, 255, 255, .5)",position:"absolute",top:0,left:0,right:0,bottom:0});s.appendTo(i);e=a.observer.applyFilters("photos_rotate_req",{photo:e,direction:t},this);a.ajax.post("photosajax.rotate_photo",e).done(t=>{t.success&&(i.data("id",t.data.file),i.find(".ps-js-img").html(`<img src="${t.data.thumb}" />`))}).always(()=>s.remove())},onRemove:function(t){var t=t.data.id,e=this.$photos.find(".ps-js-preview-"+t);this.removeTempFiles([e.data("id")]),this.emit("photo_removed",t)},triggerUpload:function(){this.upload()},addDroppable:function(e){var i=setInterval(o.proxy(function(){var t;this.$el.parent()&&(clearInterval(i),this.uploadInitialized||(this.uploadInit(),this.uploadInitialized=!0),t=(t=this.$file.psFileupload("option","dropZone")).add(e),this.$file.psFileupload("option","dropZone",t))},this),1e3)}}),i)}(jQuery,peepso);