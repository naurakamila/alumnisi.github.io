!function(o){t="PsPostboxPhoto",s=o;var t,s,e=peepso.createClass(t,{__constructor:function(){this.canSubmitFlag=!1,this.dropzone=null},set_postbox:function(o){this.$postbox=o,this.$posttab=o.$posttabs},init:function(){this.initialize()},initialize:function(){this.$text=this.$postbox.$textarea,this.$textContainer=this.$text.closest(".ps-postbox-status");var o=this.$postbox.find(".ps-postbox-tabs").children("[data-tab-id=photos]");this.$uploadButton=o.find(".ps-postbox-photo-upload"),this.$uploadPreview=o.find(".ps-postbox-preview"),this.$posttab.on("peepso_posttabs_show-photos",s.proxy(this.show,this)),this.$posttab.on("peepso_posttabs_cancel-photos",s.proxy(this.cancel,this)),this.$posttab.on("peepso_posttabs_submit-photos",s.proxy(this.post,this)),peepso.observer.addAction("postbox_type_set",s.proxy(function(o,t){o===this.$postbox&&"photos"===t&&this.$phototab.trigger("click")},this),10,2),this.$uploadButton.on("click",s.proxy(this.upload,this)),this.$phototab=this.$postbox.find("#photo-post"),this.$phototab.on("click",s.proxy(this.onCameraTabClick,this)),this.placeholderDefault=this.$text.attr("placeholder"),this.placeholderPhoto=s("#photo-comment-label").text(),peepso.observer.addFilter("peepso_postbox_can_submit",s.proxy(this.canSubmit,this),20,1),peepso.observer.addAction("psmessage_new_message_close",s.proxy(function(o){this.dropzone.empty()},this),10,1),peepso.observer.addAction("postbox_group_set",s.proxy(function(o,t){this.$postbox===o&&(this.groupId=t,this.dropzone.empty())},this),10,2),peepso.observer.addAction("postbox_group_reset",s.proxy(function(o,t){this.$postbox===o&&(this.groupId=void 0,this.dropzone.empty())},this),10,2),peepso.observer.addFilter("photos_validate_req",s.proxy(function(o,t){return this.dropzone===t&&this.groupId&&(o.group_id=this.groupId,o.module_id=window.peepsogroupsdata&&peepsogroupsdata.module_id),o},this),10,2),peepso.observer.addFilter("photos_upload_req",s.proxy(function(o,t){return this.dropzone===t&&this.groupId&&(o.group_id=this.groupId,o.module_id=window.peepsogroupsdata&&peepsogroupsdata.module_id),o},this),10,2),peepso.observer.addFilter("photos_rotate_req",s.proxy(function(o,t){return this.dropzone===t&&this.groupId&&(o.group_id=this.groupId,o.module_id=window.peepsogroupsdata&&peepsogroupsdata.module_id),o},this),10,2)},show:function(o,t){t.show(),this.showButton(),this.$phototab.addClass("active"),this.$text.attr("placeholder",this.placeholderPhoto),this.dropzoneInit()},showButton:function(){this.$uploadPreview.hide(),this.$textContainer.show(),this.$uploadButton.show(),this.$postbox.on_change()},showPreview:function(){this.$uploadButton.hide(),this.$uploadPreview.show(),this.$textContainer.show(),this.$text.focus()},upload:function(){this.dropzone.triggerUpload()},cancel:function(){this.dropzone.empty(),this.showButton(),this.$phototab.removeClass("active"),this.$text.attr("placeholder",this.placeholderDefault)},post:function(){var o="postbox_req_"+this.$postbox.guid;peepso.observer.addFilter(o,this.postSetRequest,10,1,this),this.$postbox.save_post(),peepso.observer.removeFilter(o,this.postSetRequest,10),this.dropzone.empty("save")},postSetRequest:function(o){return s.extend(o,{files:this.dropzone.getPhotos(),type:"photo"})},canSubmit:function(o){return"photos"===this.$posttab.current_tab_id&&o.hard.push(this.canSubmitFlag),o},dropzoneInit:function(){this.dropzone||(this.dropzone=new peepso.PhotoDropzone(this.$uploadPreview),this.dropzone.on("photo_added",s.proxy(this.dropzonePhotoAdded,this)),this.dropzone.on("photo_upload_start",s.proxy(this.dropzonePhotoUploadStart,this)),this.dropzone.on("photo_upload_done",s.proxy(this.dropzonePhotoUploadDone,this)),this.dropzone.on("photo_empty",s.proxy(this.dropzonePhotoEmpty,this)),this.dropzone.addDroppable(this.$uploadButton[0]))},dropzonePhotoAdded:function(){this.showPreview()},dropzonePhotoUploadStart:function(){this.canSubmitFlag=!1},dropzonePhotoUploadDone:function(o){o<=0&&(this.canSubmitFlag=!0,this.$postbox.on_change())},dropzonePhotoEmpty:function(){this.canSubmitFlag=!1,"photos"===this.$posttab.current_tab_id&&this.showButton()},onCameraTabClick:function(){"photos"!==this.$posttab.current_tab_id&&this.$postbox.find("[data-tab=photos]").trigger("click")}});peepso.observer.addFilter("peepso_postbox_addons",function(o){return o.push(new e),o},10,1),peepso.observer.addAction("postbox_init",function(o){o.$tabContext.find("#photo-post").remove()},10,1)}(jQuery);